# 부위별 우선순위 규칙

## 개요

다중 부위 선택 시 각 부위의 운동을 병합할 때 우선순위를 결정하는 규칙을 정의합니다.

## 우선순위 결정 요소

### 1. 통증 정도 (Pain Level)
- **범위**: 1-5 (5가 가장 심함)
- **가중치**: × 100
- **규칙**: 통증이 높을수록 우선순위가 높음
- **이유**: 통증이 심한 부위를 우선적으로 재활해야 함

### 2. 부위 기본 우선순위
- **범위**: 1-10 (낮을수록 우선순위 높음)
- **가중치**: × 10
- **규칙**: 의학적 중요도와 일상생활에 미치는 영향도를 반영

**부위별 기본 우선순위**:
- 허리: 1 (가장 중요 - 일상생활에 큰 영향)
- 무릎: 2 (보행에 중요)
- 어깨: 3 (상지 기능에 중요)
- 목: 4 (경추 건강)
- 손목: 5 (손 기능)
- 발목: 5 (보행 안정성)
- 팔꿈치: 6 (상지 기능)
- 엉덩이: 6 (하지 안정성)
- 등: 7 (전신 자세)
- 가슴: 8 (호흡 및 자세)

### 3. 운동 강도 (Intensity Level)
- **범위**: 1-4 (1이 가장 낮음)
- **가중치**: × 1 (감산)
- **규칙**: 낮은 강도(1-2)가 높은 강도(3-4)보다 우선
- **이유**: 안전 우선 원칙 (재활 초기에는 낮은 강도부터 시작)

### 4. 매핑 우선순위 (Mapping Priority)
- **범위**: 1 이상 (낮을수록 우선순위 높음)
- **가중치**: × 0.1
- **규칙**: `body_part_exercise_mappings.priority` 값 사용
- **이유**: 같은 부위 내에서도 운동 간 우선순위가 다름

### 5. 사용자 선택 순서 (선택적, 향후 확장)
- **범위**: 1 이상 (낮을수록 먼저 선택)
- **가중치**: × 0.01 (매우 작은 가중치)
- **규칙**: 사용자가 먼저 선택한 부위가 약간 더 우선
- **현재**: 미구현 (향후 확장 가능)

## 우선순위 계산 공식

```
우선순위 점수 = (통증 정도 × 100) 
              + (부위 기본 우선순위 × 10) 
              - (운동 강도 × 1) 
              + (매핑 priority × 0.1)
              + (선택 순서 × 0.01) [선택적]

낮을수록 우선순위 높음
```

## 계산 예시

### 예시 1: 허리 vs 어깨
- **허리**: 통증 5점, 기본 우선순위 1, 강도 1, 매핑 priority 1
  - 점수: (5×100) + (1×10) - (1×1) + (1×0.1) = **509.1**
- **어깨**: 통증 3점, 기본 우선순위 3, 강도 2, 매핑 priority 1
  - 점수: (3×100) + (3×10) - (2×1) + (1×0.1) = **328.1**

**결과**: 어깨가 더 높은 우선순위 (점수가 낮음)
- 하지만 통증이 높은 허리 운동도 포함됨 (다중 부위 병합)

### 예시 2: 같은 부위 내 다른 운동
- **허리 운동 A**: 통증 5점, 기본 우선순위 1, 강도 1, 매핑 priority 1
  - 점수: (5×100) + (1×10) - (1×1) + (1×0.1) = **509.1**
- **허리 운동 B**: 통증 5점, 기본 우선순위 1, 강도 2, 매핑 priority 2
  - 점수: (5×100) + (1×10) - (2×1) + (2×0.1) = **508.2**

**결과**: 운동 A가 더 높은 우선순위 (점수가 낮음)

## 우선순위 적용 규칙

### 1. 다중 부위 병합 시
- 각 부위별로 우선순위 점수를 계산
- 점수가 낮은 운동부터 선택
- 같은 운동이 여러 부위에 적용되는 경우, 가장 낮은 점수 사용

### 2. 중복 운동 처리
- 같은 `exercise_template_id`를 가진 운동들은 하나로 병합
- 여러 부위에 적용되는 운동은 `bodyPartIds` 배열에 모든 부위 포함
- 우선순위 점수는 가장 높은 우선순위(가장 낮은 점수) 사용

### 3. 시간 배분
- 우선순위가 높은 운동부터 시간 배분
- 최소 운동 시간 보장 (각 운동 최소 5분)

## 통증 정도별 필터링

### pain_level_range 매칭 규칙
- `'1-2'`: 통증 1-2점에 적용
- `'3-4'`: 통증 3-4점에 적용
- `'5'`: 통증 5점에 적용
- `'all'`: 모든 통증 정도에 적용

### 예시
- 사용자 통증: 3점
- 매칭되는 범위: `'1-2'`, `'3-4'`, `'all'`
- 제외되는 범위: `'5'`

## 참고사항

- 초기에는 하드코딩된 우선순위로 시작
- 필요시 데이터베이스 테이블(`body_part_priorities`)로 전환 가능
- 우선순위 규칙은 재활 전문가와 상의하여 조정 가능
- 사용자 피드백을 바탕으로 가중치 조정 가능

