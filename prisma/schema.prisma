// ===================================================
// REHAB 재활운동 어플리케이션 - Prisma 스키마
// PRD.md와 db.sql 기반 설계
// Prisma 7 형식
// ===================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// 1️⃣ 사용자 테이블
// ============================================

model User {
  id          String   @id @default(uuid()) @db.Uuid
  clerkId     String?  @unique @map("clerk_id") // Clerk 사용자 ID
  email       String?  @unique
  name        String? // 사용자 이름 (Clerk 동기화 API에서 사용)
  displayName String?  @map("display_name")
  isAdmin     Boolean  @default(false) @map("is_admin")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  reviews           Review[]
  courses           Course[]
  userPainProfiles  UserPainProfile[]
  userCourseHistory UserCourseHistory[]
  userFavorites     UserFavorite[]
  events            Event[]
  fitnessProfile    UserFitnessProfile?  // NEW: 운동 프로필
  gymReports        GymReport[]          // NEW: 헬스장 제보
  reviewVotes       ReviewVote[]         @relation("ReviewVotes") // NEW: 리뷰 투표
  progressLogs      UserProgressLog[]    @relation("UserProgressLogs") // NEW: 진행 로그
  wearableData      WearableData[]       @relation("UserWearableData") // P3-W1-01
  courseCompletionLogs CourseCompletionLog[] @relation("UserCompletionLogs") // P3-AI-01

  @@index([clerkId], map: "idx_users_clerk_id")
  @@index([isActive], map: "idx_users_is_active")
  @@index([isAdmin], map: "idx_users_is_admin")
  @@map("users")
}

// 사용자 피트니스 프로필 (ENG-S4-01)
model UserFitnessProfile {
  id                  String    @id @default(uuid()) @db.Uuid
  userId              String    @unique @map("user_id") @db.Uuid
  fitnessLevel        Int       @default(2) @map("fitness_level")  // 1-5
  rehabPhase          String    @default("initial") @map("rehab_phase")  // initial, recovery, strengthening
  lastAssessment      DateTime? @map("last_assessment") @db.Timestamptz
  avgCompletionRate   Float?    @map("avg_completion_rate")  // 0.0-1.0
  avgPainReduction    Float?    @map("avg_pain_reduction")   // 평균 통증 감소율
  totalCoursesCompleted Int     @default(0) @map("total_courses_completed")
  currentStreak         Int     @default(0) @map("current_streak")
  longestStreak         Int     @default(0) @map("longest_streak")
  lastWorkoutDate       DateTime? @map("last_workout_date") @db.Timestamptz
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([fitnessLevel], map: "idx_user_fitness_profiles_fitness_level")
  @@index([rehabPhase], map: "idx_user_fitness_profiles_rehab_phase")
  @@map("user_fitness_profiles")
}

// ============================================
// 2️⃣ 헬스장 관련 테이블
// ============================================

model Gym {
  id                String    @id @default(uuid()) @db.Uuid
  name              String
  address           String
  latitude          Decimal   @db.Decimal(10, 8)
  longitude         Decimal   @db.Decimal(11, 8)
  phone             String?
  website           String?
  priceRange        String?   @map("price_range") @db.VarChar(20)
  description       String?
  isActive          Boolean   @default(true) @map("is_active")
  facilityInfoCount Int       @default(0) @map("facility_info_count")
  lastUpdatedAt     DateTime? @map("last_updated_at") @db.Timestamptz
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  facilities     GymFacility?
  operatingHours GymOperatingHour[]
  crowdLevels    GymCrowdLevel[]
  reviews        Review[]
  userFavorites  UserFavorite[]
  reports        GymReport[]

  @@index([latitude, longitude], map: "idx_gyms_location")
  @@index([isActive], map: "idx_gyms_is_active")
  @@index([priceRange], map: "idx_gyms_price_range")
  @@map("gyms")
}

// 헬스장 사용자 제보 (P2-LOC-S1-01)
model GymReport {
  id             String    @id @default(uuid()) @db.Uuid
  gymId          String    @map("gym_id") @db.Uuid
  userId         String?   @map("user_id") @db.Uuid
  reportType     String    @map("report_type") @db.VarChar(30)  // "info_wrong", "closed", "moved", "hours_changed", "other"
  fieldName      String?   @map("field_name") @db.VarChar(50)   // "name", "address", "phone", "operatingHours"
  currentValue   String?   @map("current_value")
  suggestedValue String?   @map("suggested_value")
  description    String?
  status         String    @default("pending") @db.VarChar(20)  // "pending", "approved", "rejected"
  reviewedBy     String?   @map("reviewed_by") @db.Uuid
  reviewNote     String?   @map("review_note")
  reviewedAt     DateTime? @map("reviewed_at") @db.Timestamptz
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  gym  Gym   @relation(fields: [gymId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([gymId], map: "idx_gym_reports_gym_id")
  @@index([status], map: "idx_gym_reports_status")
  @@index([createdAt], map: "idx_gym_reports_created_at")
  @@map("gym_reports")
}

model GymFacility {
  id                 String   @id @default(uuid()) @db.Uuid
  gymId              String   @unique @map("gym_id") @db.Uuid
  isQuiet            Boolean  @default(false) @map("is_quiet")
  hasRehabEquipment  Boolean  @default(false) @map("has_rehab_equipment")
  hasPtCoach         Boolean  @default(false) @map("has_pt_coach")
  hasShower          Boolean  @default(false) @map("has_shower")
  hasParking         Boolean  @default(false) @map("has_parking")
  hasLocker          Boolean  @default(false) @map("has_locker")
  hasWaterDispenser  Boolean  @default(false) @map("has_water_dispenser")
  hasAirConditioning Boolean  @default(false) @map("has_air_conditioning")
  otherFacilities    String[] @map("other_facilities")
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  gym Gym @relation(fields: [gymId], references: [id], onDelete: Cascade)

  @@index([gymId], map: "idx_gym_facilities_gym_id")
  @@index([isQuiet], map: "idx_gym_facilities_is_quiet")
  @@index([hasRehabEquipment], map: "idx_gym_facilities_has_rehab_equipment")
  @@index([hasPtCoach], map: "idx_gym_facilities_has_pt_coach")
  @@map("gym_facilities")
}

model GymOperatingHour {
  id        String   @id @default(uuid()) @db.Uuid
  gymId     String   @map("gym_id") @db.Uuid
  dayOfWeek Int      @map("day_of_week")
  openTime  String?  @map("open_time")
  closeTime String?  @map("close_time")
  isClosed  Boolean  @default(false) @map("is_closed")
  isVerified Boolean  @default(false) @map("is_verified") // 관리자 검증 여부
  notes     String?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  gym Gym @relation(fields: [gymId], references: [id], onDelete: Cascade)

  @@unique([gymId, dayOfWeek], map: "gym_operating_hours_unique")
  @@index([gymId], map: "idx_gym_operating_hours_gym_id")
  @@index([dayOfWeek], map: "idx_gym_operating_hours_day_of_week")
  @@map("gym_operating_hours")
}

model GymCrowdLevel {
  id         String    @id @default(uuid()) @db.Uuid
  gymId      String    @map("gym_id") @db.Uuid
  timeSlot   String    @map("time_slot") @db.VarChar(20)
  dayOfWeek  Int?      @map("day_of_week")
  crowdLevel String    @map("crowd_level") @db.VarChar(20) // 'quiet', 'normal', 'busy'
  source     String    @default("manual") @db.VarChar(20)
  reportedAt DateTime? @map("reported_at") @db.Timestamptz
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  gym Gym @relation(fields: [gymId], references: [id], onDelete: Cascade)

  @@index([gymId], map: "idx_gym_crowd_levels_gym_id")
  @@index([timeSlot], map: "idx_gym_crowd_levels_time_slot")
  @@index([crowdLevel], map: "idx_gym_crowd_levels_crowd_level")
  @@map("gym_crowd_levels")
}

// ============================================
// 3️⃣ 리뷰 관련 테이블
// ============================================

model ReviewTag {
  id           String   @id @default(uuid()) @db.Uuid
  name         String   @unique
  category     String?  @db.VarChar(50)
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  reviewTagMappings ReviewTagMapping[]

  @@index([category], map: "idx_review_tags_category")
  @@index([displayOrder], map: "idx_review_tags_display_order")
  @@map("review_tags")
}

model Review {
  id            String   @id @default(uuid()) @db.Uuid
  gymId         String   @map("gym_id") @db.Uuid
  userId        String?  @map("user_id") @db.Uuid
  comment       String?
  isAdminReview Boolean  @default(false) @map("is_admin_review")
  isDeleted     Boolean  @default(false) @map("is_deleted")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  gym               Gym                @relation(fields: [gymId], references: [id], onDelete: Cascade)
  user              User?              @relation(fields: [userId], references: [id], onDelete: SetNull)
  reviewTagMappings ReviewTagMapping[]
  votes             ReviewVote[]       // 리뷰 투표

  @@index([gymId], map: "idx_reviews_gym_id")
  @@index([userId], map: "idx_reviews_user_id")
  @@index([isDeleted], map: "idx_reviews_is_deleted")
  @@index([isAdminReview], map: "idx_reviews_is_admin_review")
  @@index([createdAt(sort: Desc)], map: "idx_reviews_created_at")
  @@map("reviews")
}

model ReviewTagMapping {
  id          String   @id @default(uuid()) @db.Uuid
  reviewId    String   @map("review_id") @db.Uuid
  reviewTagId String   @map("review_tag_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  review    Review    @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  reviewTag ReviewTag @relation(fields: [reviewTagId], references: [id], onDelete: Cascade)

  @@unique([reviewId, reviewTagId], map: "review_tag_mappings_unique")
  @@index([reviewId], map: "idx_review_tag_mappings_review_id")
  @@index([reviewTagId], map: "idx_review_tag_mappings_review_tag_id")
  @@map("review_tag_mappings")
}

// 리뷰 투표 (P2-S2-03)
model ReviewVote {
  id        String   @id @default(uuid()) @db.Uuid
  reviewId  String   @map("review_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user   User   @relation("ReviewVotes", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId], map: "review_votes_unique")
  @@index([reviewId], map: "idx_review_votes_review_id")
  @@index([userId], map: "idx_review_votes_user_id")
  @@map("review_votes")
}

// ============================================
// 4️⃣ 재활 코스 관련 테이블
// ============================================

model BodyPart {
  id           String   @id @default(uuid()) @db.Uuid
  name         String   @unique
  parentId     String?  @map("parent_id") @db.Uuid  // 상위 부위 (계층 구조)
  level        Int      @default(1)                  // 계층 레벨 (1=대분류, 2=소분류)
  synonyms     String[] @default([])                 // 동의어 배열
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Self-relation for hierarchy
  parent       BodyPart?  @relation("BodyPartHierarchy", fields: [parentId], references: [id])
  children     BodyPart[] @relation("BodyPartHierarchy")

  // Other relations
  exerciseTemplates ExerciseTemplate[]
  userPainProfiles  UserPainProfile[]
  exerciseMappings  BodyPartExerciseMapping[]
  contraindications BodyPartContraindication[]
  progressLogs      UserProgressLog[]    @relation("ProgressLogs") // NEW: 진행 로그

  @@index([parentId], map: "idx_body_parts_parent_id")
  @@index([displayOrder], map: "idx_body_parts_display_order")
  @@map("body_parts")
}

model EquipmentType {
  id           String   @id @default(uuid()) @db.Uuid
  name         String   @unique
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  exerciseEquipmentMappings ExerciseEquipmentMapping[]

  @@index([displayOrder], map: "idx_equipment_types_display_order")
  @@map("equipment_types")
}

model ExerciseTemplate {
  id                String   @id @default(uuid()) @db.Uuid
  name              String
  description       String?
  bodyPartId        String   @map("body_part_id") @db.Uuid
  intensityLevel    Int?     @map("intensity_level")
  durationMinutes   Int?     @map("duration_minutes")
  reps              Int?
  sets              Int?
  restSeconds       Int?     @map("rest_seconds")
  difficultyScore   Int?     @map("difficulty_score")
  contraindications String[] @map("contraindications")
  instructions      String?
  precautions       String?
  isActive          Boolean  @default(true) @map("is_active")
  // 미디어 필드 (ExerciseDB API 연동용)
  imageUrl          String?  @map("image_url")
  gifUrl            String?  @map("gif_url")
  videoUrl          String?  @map("video_url")
  englishName       String?  @map("english_name")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  bodyPart                  BodyPart                   @relation(fields: [bodyPartId], references: [id])
  exerciseEquipmentMappings ExerciseEquipmentMapping[]
  courseExercises           CourseExercise[]
  bodyPartExerciseMappings  BodyPartExerciseMapping[]
  bodyPartContraindications BodyPartContraindication[]
  courseCompletionLogs      CourseCompletionLog[] @relation("ExerciseCompletionLogs") // P3-AI-01
  exerciseMedia             ExerciseMedia[]       // P3-M1-01
  postureGuides             PostureGuide[]        // P3-M1-02
  localizedExercises        LocalizedExercise[]   // P3-G1-01

  @@index([bodyPartId], map: "idx_exercise_templates_body_part_id")
  @@index([intensityLevel], map: "idx_exercise_templates_intensity_level")
  @@index([isActive], map: "idx_exercise_templates_is_active")
  @@map("exercise_templates")
}

model ExerciseEquipmentMapping {
  id                 String   @id @default(uuid()) @db.Uuid
  exerciseTemplateId String   @map("exercise_template_id") @db.Uuid
  equipmentTypeId    String   @map("equipment_type_id") @db.Uuid
  isRequired         Boolean  @default(false) @map("is_required")
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  exerciseTemplate ExerciseTemplate @relation(fields: [exerciseTemplateId], references: [id], onDelete: Cascade)
  equipmentType    EquipmentType    @relation(fields: [equipmentTypeId], references: [id], onDelete: Cascade)

  @@unique([exerciseTemplateId, equipmentTypeId], map: "exercise_equipment_mappings_unique")
  @@index([exerciseTemplateId], map: "idx_exercise_equipment_mappings_exercise_template_id")
  @@index([equipmentTypeId], map: "idx_exercise_equipment_mappings_equipment_type_id")
  @@map("exercise_equipment_mappings")
}

model BodyPartExerciseMapping {
  id                 String   @id @default(uuid()) @db.Uuid
  bodyPartId         String   @map("body_part_id") @db.Uuid
  exerciseTemplateId String   @map("exercise_template_id") @db.Uuid
  priority           Int
  intensityLevel     Int?     @map("intensity_level")
  painLevelRange     String?  @map("pain_level_range") @db.VarChar(20)
  isActive           Boolean  @default(true) @map("is_active")
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  bodyPart         BodyPart         @relation(fields: [bodyPartId], references: [id], onDelete: Cascade)
  exerciseTemplate ExerciseTemplate @relation(fields: [exerciseTemplateId], references: [id], onDelete: Cascade)

  @@unique([bodyPartId, exerciseTemplateId, painLevelRange], map: "body_part_exercise_mappings_unique")
  @@index([bodyPartId], map: "idx_body_part_exercise_mappings_body_part_id")
  @@index([exerciseTemplateId], map: "idx_body_part_exercise_mappings_exercise_template_id")
  @@index([priority], map: "idx_body_part_exercise_mappings_priority")
  @@index([painLevelRange], map: "idx_body_part_exercise_mappings_pain_level_range")
  @@map("body_part_exercise_mappings")
}

model BodyPartContraindication {
  id                 String   @id @default(uuid()) @db.Uuid
  bodyPartId         String   @map("body_part_id") @db.Uuid
  exerciseTemplateId String   @map("exercise_template_id") @db.Uuid
  painLevelMin       Int?     @map("pain_level_min")     // 최소 통증 레벨
  painLevelMax       Int?     @map("pain_level_max")     // 최대 통증 레벨 (NEW)
  condition          String?  @db.VarChar(50)            // 조건: "급성", "만성", "수술후" (NEW)
  reason             String?
  severity           String   @default("warning") @db.VarChar(20) // "soft" | "hard"
  isActive           Boolean  @default(true) @map("is_active")
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  bodyPart         BodyPart         @relation(fields: [bodyPartId], references: [id], onDelete: Cascade)
  exerciseTemplate ExerciseTemplate @relation(fields: [exerciseTemplateId], references: [id], onDelete: Cascade)

  @@unique([bodyPartId, exerciseTemplateId, painLevelMin], map: "body_part_contraindications_unique")
  @@index([bodyPartId], map: "idx_body_part_contraindications_body_part_id")
  @@index([exerciseTemplateId], map: "idx_body_part_contraindications_exercise_template_id")
  @@index([painLevelMin], map: "idx_body_part_contraindications_pain_level_min")
  @@map("body_part_contraindications")
}

model Course {
  id                   String   @id @default(uuid()) @db.Uuid
  userId               String?  @map("user_id") @db.Uuid
  // PRD.md 요구사항: 60, 90, 120분만 허용 (데이터베이스 레벨 CHECK 제약조건 존재)
  // 애플리케이션 레벨에서도 검증 필요
  totalDurationMinutes Int      @map("total_duration_minutes") // 60, 90, 120만 허용
  painLevel            Int?     @map("pain_level")
  experienceLevel      String?  @map("experience_level") @db.VarChar(20)
  bodyParts            String[] @map("body_parts")
  equipmentAvailable   String[] @map("equipment_available")
  courseType           String   @default("warmup_main_cooldown") @map("course_type") @db.VarChar(20)
  isTemplate           Boolean  @default(false) @map("is_template")
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user              User?               @relation(fields: [userId], references: [id], onDelete: SetNull)
  courseExercises   CourseExercise[]
  userCourseHistory UserCourseHistory[]
  courseCompletionLogs CourseCompletionLog[] @relation("CourseCompletionLogs") // P3-AI-01

  @@index([userId], map: "idx_courses_user_id")
  @@index([painLevel], map: "idx_courses_pain_level")
  @@index([isTemplate], map: "idx_courses_is_template")
  @@index([createdAt(sort: Desc)], map: "idx_courses_created_at")
  @@map("courses")
}

model CourseExercise {
  id                 String   @id @default(uuid()) @db.Uuid
  courseId           String   @map("course_id") @db.Uuid
  exerciseTemplateId String   @map("exercise_template_id") @db.Uuid
  section            String // 'warmup', 'main', 'cooldown'
  orderInSection     Int      @map("order_in_section")
  durationMinutes    Int?     @map("duration_minutes")
  reps               Int?
  sets               Int?
  restSeconds        Int?     @map("rest_seconds")
  notes              String?
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  course           Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  exerciseTemplate ExerciseTemplate @relation(fields: [exerciseTemplateId], references: [id])

  @@index([courseId], map: "idx_course_exercises_course_id")
  @@index([exerciseTemplateId], map: "idx_course_exercises_exercise_template_id")
  @@index([section, orderInSection], map: "idx_course_exercises_section")
  @@map("course_exercises")
}

// ============================================
// 5️⃣ 사용자 관련 테이블
// ============================================

model UserPainProfile {
  id                 String   @id @default(uuid()) @db.Uuid
  userId             String?  @map("user_id") @db.Uuid
  bodyPartId         String   @map("body_part_id") @db.Uuid
  painLevel          Int?     @map("pain_level")
  experienceLevel    String?  @map("experience_level") @db.VarChar(20)
  equipmentAvailable String[] @map("equipment_available")
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user     User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  bodyPart BodyPart @relation(fields: [bodyPartId], references: [id])

  @@index([userId], map: "idx_user_pain_profiles_user_id")
  @@index([bodyPartId], map: "idx_user_pain_profiles_body_part_id")
  @@map("user_pain_profiles")
}

model UserCourseHistory {
  id          String    @id @default(uuid()) @db.Uuid
  userId      String?   @map("user_id") @db.Uuid
  courseId    String    @map("course_id") @db.Uuid
  completedAt DateTime? @map("completed_at") @db.Timestamptz
  savedAt     DateTime  @default(now()) @map("saved_at") @db.Timestamptz
  isFavorite  Boolean   @default(false) @map("is_favorite")
  notes       String?
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user   User?  @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_user_course_history_user_id")
  @@index([courseId], map: "idx_user_course_history_course_id")
  @@index([savedAt(sort: Desc)], map: "idx_user_course_history_saved_at")
  @@index([isFavorite], map: "idx_user_course_history_is_favorite")
  @@map("user_course_history")
}

model UserFavorite {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  gymId     String   @map("gym_id") @db.Uuid
  savedAt   DateTime @default(now()) @map("saved_at") @db.Timestamptz
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)
  gym  Gym   @relation(fields: [gymId], references: [id], onDelete: Cascade)

  @@unique([userId, gymId], map: "user_favorites_unique")
  @@index([userId], map: "idx_user_favorites_user_id")
  @@index([gymId], map: "idx_user_favorites_gym_id")
  @@index([savedAt(sort: Desc)], map: "idx_user_favorites_saved_at")
  @@map("user_favorites")
}

// ============================================
// 6️⃣ 분석 관련 테이블
// ============================================

model Event {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String?  @map("user_id") @db.Uuid
  anonymousId String?  @map("anonymous_id")
  eventName   String   @map("event_name") @db.VarChar(100)
  eventData   Json?    @map("event_data") @db.JsonB
  eventTime   DateTime @default(now()) @map("event_time") @db.Timestamptz
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId], map: "idx_events_user_id")
  @@index([anonymousId], map: "idx_events_anonymous_id")
  @@index([eventName], map: "idx_events_event_name")
  @@index([eventTime(sort: Desc)], map: "idx_events_event_time")
  @@map("events")
}

// ============================================
// 7️⃣ 사용자 진행 상황 추적 (P2-3-S2)
// ============================================

model UserProgressLog {
  id            String   @id @default(uuid()) @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  bodyPartId    String   @map("body_part_id") @db.Uuid
  painLevel     Int      @map("pain_level")                     // 1-10 스케일
  rangeOfMotion Int?     @map("range_of_motion")                // 0-100% (선택)
  notes         String?                                          // 메모
  recordedAt    DateTime @default(now()) @map("recorded_at") @db.Timestamptz
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  user     User     @relation("UserProgressLogs", fields: [userId], references: [id], onDelete: Cascade)
  bodyPart BodyPart @relation("ProgressLogs", fields: [bodyPartId], references: [id])

  @@index([userId], map: "idx_user_progress_logs_user_id")
  @@index([bodyPartId], map: "idx_user_progress_logs_body_part_id")
  @@index([recordedAt(sort: Desc)], map: "idx_user_progress_logs_recorded_at")
  @@map("user_progress_logs")
}

// P3-W1-01: 웨어러블 건강 데이터
model WearableData {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  source     String   @db.VarChar(30)      // healthkit | googlefit | manual
  dataType   String   @map("data_type") @db.VarChar(30) // steps | heart_rate | sleep | calories
  value      Float
  unit       String?  @db.VarChar(20)      // count | bpm | hours | kcal
  recordedAt DateTime @map("recorded_at") @db.Timestamptz
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  user User @relation("UserWearableData", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, dataType, recordedAt], map: "idx_wearable_data_user_type_date")
  @@index([userId], map: "idx_wearable_data_user_id")
  @@map("wearable_data")
}

// P3-AI-01: 코스 완료 로그 (운동별 완료/스킵 기록)
model CourseCompletionLog {
  id                 String   @id @default(uuid()) @db.Uuid
  userId             String   @map("user_id") @db.Uuid
  courseId           String   @map("course_id") @db.Uuid
  exerciseTemplateId String   @map("exercise_template_id") @db.Uuid
  status             String   @db.VarChar(20) // completed | skipped | modified
  actualDuration     Int?     @map("actual_duration") // 실제 수행 시간(분)
  userRating         Int?     @map("user_rating") // 1-5 만족도
  painAfter          Int?     @map("pain_after") // 운동 후 통증 1-10
  notes              String?
  completedAt        DateTime @default(now()) @map("completed_at") @db.Timestamptz

  // Relations
  user             User             @relation("UserCompletionLogs", fields: [userId], references: [id], onDelete: Cascade)
  course           Course           @relation("CourseCompletionLogs", fields: [courseId], references: [id], onDelete: Cascade)
  exerciseTemplate ExerciseTemplate @relation("ExerciseCompletionLogs", fields: [exerciseTemplateId], references: [id])

  @@index([userId, completedAt], map: "idx_course_completion_logs_user_date")
  @@index([courseId], map: "idx_course_completion_logs_course_id")
  @@index([exerciseTemplateId], map: "idx_course_completion_logs_exercise_id")
  @@map("course_completion_logs")
}

// P3-M1-01: 운동 미디어 (이미지/Lottie/비디오)
model ExerciseMedia {
  id                 String   @id @default(uuid()) @db.Uuid
  exerciseTemplateId String   @map("exercise_template_id") @db.Uuid
  mediaType          String   @map("media_type") @db.VarChar(20) // image | lottie | video
  purpose            String   @db.VarChar(30) // thumbnail | start_pose | end_pose | motion
  url                String
  order              Int      @default(0)
  metadata           Json?    // { width, height, duration, lottieVersion 등 }
  isActive           Boolean  @default(true) @map("is_active")
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz

  exerciseTemplate ExerciseTemplate @relation(fields: [exerciseTemplateId], references: [id], onDelete: Cascade)

  @@index([exerciseTemplateId, purpose], map: "idx_exercise_media_template_purpose")
  @@map("exercise_media")
}

// P3-M1-02: 자세 가이드 (단계별 지침)
model PostureGuide {
  id                 String   @id @default(uuid()) @db.Uuid
  exerciseTemplateId String   @map("exercise_template_id") @db.Uuid
  stepNumber         Int      @map("step_number")
  instruction        String
  commonMistake      String?  @map("common_mistake")
  correction         String?
  imageUrl           String?  @map("image_url")
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz

  exerciseTemplate ExerciseTemplate @relation(fields: [exerciseTemplateId], references: [id], onDelete: Cascade)

  @@unique([exerciseTemplateId, stepNumber], map: "posture_guides_unique")
  @@map("posture_guides")
}

// P3-G1-01: 다국어 운동 데이터
model LocalizedExercise {
  id                 String   @id @default(uuid()) @db.Uuid
  exerciseTemplateId String   @map("exercise_template_id") @db.Uuid
  locale             String   @db.VarChar(10) // en, ko, ja, zh
  name               String
  description        String?
  instructions       String?
  precautions        String?
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz

  exerciseTemplate ExerciseTemplate @relation(fields: [exerciseTemplateId], references: [id], onDelete: Cascade)

  @@unique([exerciseTemplateId, locale], map: "localized_exercises_unique")
  @@index([locale], map: "idx_localized_exercises_locale")
  @@map("localized_exercises")
}
